import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:share_plus/share_plus.dart';
import 'package:qr_flutter/qr_flutter.dart'; // Add this package
import 'dart:io' show Platform;

class InstructionDialog extends StatelessWidget {
  final String message;
  final String buttonText;
  final VoidCallback onButtonPressed;
  final TextDirection textDirection;
  final double width;
  final Color backgroundColor;
  final Color buttonColor;
  final Color buttonTextColor;
  
  // Use a universal/deep link that redirects based on platform
  final String universalAppLink;
  
  // Store-specific links (as fallbacks or for direct sharing)
  final String iosAppStoreLink;
  final String androidPlayStoreLink;
  
  // Whether to show QR codes or just use the assets
  final bool generateQrCodes;

  const InstructionDialog({
    super.key,
    required this.message,
    this.buttonText = "OK",
    required this.onButtonPressed,
    this.textDirection = TextDirection.rtl,
    this.width = 0.8,
    this.backgroundColor = Colors.white,
    this.buttonColor = Colors.black,
    this.buttonTextColor = Colors.white,
    this.iosAppStoreLink = "https://apps.apple.com/il/app/lightup-crowd/id6745174049",
    this.androidPlayStoreLink = "https://play.google.com/store/apps/details?id=com.paltidigital.crowdlighting",
    this.universalAppLink = "https://yairpalti.github.io/LightUp_Store_Redirect/",
    this.generateQrCodes = false,
  });

  // Share app using the appropriate link based on the target platform
  void _shareApp(BuildContext context, {required bool isIOS}) {
    // Select the appropriate URL based on the platform selection
    final String shareUrl = isIOS ? iosAppStoreLink : androidPlayStoreLink;
    final String shareMessage = 'Check out this awesome flashlight app: $shareUrl';

    // For iOS share sheet, we need to provide the sharePositionOrigin
    if (Platform.isIOS) {
      final RenderBox? box = context.findRenderObject() as RenderBox?;
      final Rect? sharePositionOrigin = box != null
          ? Rect.fromLTWH(
              box.localToGlobal(Offset.zero).dx,
              box.localToGlobal(Offset.zero).dy,
              box.size.width,
              box.size.height * 0.75,
            )
          : null;

      Share.share(
        shareMessage,
        subject: 'LightUp Crowd App',
        sharePositionOrigin: sharePositionOrigin,
      );
    } else {
      // For Android and other platforms
      Share.share(shareMessage, subject: 'LightUp Crowd App');
    }
  }

  // Share the universal app link that works on any platform
  void _shareUniversalLink(BuildContext context) {
    final String shareMessage = 'Check out this awesome flashlight app: $universalAppLink';

    if (Platform.isIOS) {
      final RenderBox? box = context.findRenderObject() as RenderBox?;
      final Rect? sharePositionOrigin = box != null
          ? Rect.fromLTWH(
              box.localToGlobal(Offset.zero).dx,
              box.localToGlobal(Offset.zero).dy,
              box.size.width,
              box.size.height * 0.75,
            )
          : null;

      Share.share(
        shareMessage,
        subject: 'LightUp Crowd App',
        sharePositionOrigin: sharePositionOrigin,
      );
    } else {
      Share.share(shareMessage, subject: 'LightUp Crowd App');
    }
  }

  // Copy app link to clipboard
  void _copyLink(BuildContext context, String link) {
    Clipboard.setData(ClipboardData(text: link));
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(content: Text('Link copied to clipboard')),
    );
  }

  @override
  Widget build(BuildContext context) {
    final Size screenSize = MediaQuery.of(context).size;
    final bool isTablet = screenSize.shortestSide >= 600;
    final double contentWidth = MediaQuery.of(context).size.width * width;
    final bool useHorizontalLayout = contentWidth > 360;

    return Container(
      color: Colors.black.withOpacity(0.5),
      child: Center(
        child: Container(
          width: contentWidth,
          padding: EdgeInsets.all(isTablet ? 24.0 : 20.0),
          decoration: BoxDecoration(
            color: backgroundColor,
            borderRadius: BorderRadius.circular(16),
            boxShadow: [
              BoxShadow(
                color: Colors.black.withOpacity(0.2),
                blurRadius: 10,
                offset: Offset(0, 5),
              ),
            ],
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Message text
              Text(
                message,
                textAlign: TextAlign.center,
                textDirection: textDirection,
                style: TextStyle(
                  fontSize: isTablet ? 20 : 16,
                  fontWeight: FontWeight.bold,
                  color: Colors.black,
                ),
              ),
              SizedBox(height: isTablet ? 24.0 : 20.0),
              
              // Share App Title
              Text(
                "Share The App",
                textAlign: TextAlign.center,
                style: TextStyle(
                  fontSize: isTablet ? 22 : 18,
                  fontWeight: FontWeight.bold,
                  color: Colors.black,
                ),
              ),
              SizedBox(height: isTablet ? 16.0 : 12.0),
              
              // Universal QR Code
              if (generateQrCodes)
                Column(
                  children: [
                    Text(
                      "Scan to download",
                      style: TextStyle(
                        fontSize: isTablet ? 16 : 14,
                        color: Colors.black87,
                      ),
                    ),
                    SizedBox(height: 8),
                    QrImageView(
                      data: universalAppLink,
                      version: QrVersions.auto,
                      size: isTablet ? 180.0 : 140.0,
                      backgroundColor: Colors.white,
                      errorStateBuilder: (context, error) => Center(
                        child: Text('Error generating QR code'),
                      ),
                    ),
                    SizedBox(height: 8),
                    GestureDetector(
                      onTap: () => _copyLink(context, universalAppLink),
                      child: Container(
                        padding: EdgeInsets.symmetric(horizontal: 8, vertical: 4),
                        decoration: BoxDecoration(
                          color: Colors.grey.shade100,
                          borderRadius: BorderRadius.circular(4),
                          border: Border.all(color: Colors.grey.shade300),
                        ),
                        child: Row(
                          mainAxisSize: MainAxisSize.min,
                          children: [
                            Flexible(
                              child: Text(
                                universalAppLink,
                                style: TextStyle(
                                  fontSize: 12,
                                  color: Colors.blue,
                                ),
                                overflow: TextOverflow.ellipsis,
                              ),
                            ),
                            SizedBox(width: 4),
                            Icon(Icons.copy, size: 14, color: Colors.grey),
                          ],
                        ),
                      ),
                    ),
                    SizedBox(height: 8),
                    ElevatedButton.icon(
                      onPressed: () => _shareUniversalLink(context),
                      icon: Icon(Icons.share, size: 18),
                      label: Text("Share App Link"),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.purple,
                        foregroundColor: Colors.white,
                        padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                      ),
                    ),
                    Divider(height: 32),
                    Text(
                      "Or share directly to:",
                      style: TextStyle(
                        fontSize: 14,
                        color: Colors.black54,
                      ),
                    ),
                    SizedBox(height: 8),
                  ],
                ),
              
              // Platform-specific QR codes
              useHorizontalLayout
                  ? Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        _buildPlatformQRCode(context, true, isTablet),  // iOS
                        _buildPlatformQRCode(context, false, isTablet), // Android
                      ],
                    )
                  : Column(
                      children: [
                        _buildPlatformQRCode(context, true, isTablet),  // iOS
                        SizedBox(height: 20),
                        _buildPlatformQRCode(context, false, isTablet), // Android
                      ],
                    ),

              SizedBox(height: isTablet ? 24.0 : 20.0),
              
              // OK Button
              ElevatedButton(
                onPressed: onButtonPressed,
                style: ElevatedButton.styleFrom(
                  backgroundColor: buttonColor,
                  foregroundColor: buttonTextColor,
                  padding: EdgeInsets.symmetric(
                    horizontal: isTablet ? 32 : 24,
                    vertical: isTablet ? 12 : 8,
                  ),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(30),
                  ),
                ),
                child: Text(
                  buttonText,
                  style: TextStyle(
                    fontSize: isTablet ? 18 : 16,
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildPlatformQRCode(BuildContext context, bool isIOS, bool isTablet) {
    final String platformLink = isIOS ? iosAppStoreLink : androidPlayStoreLink;
    
    return Column(
      children: [
        // Platform name
        Text(
          isIOS ? "iOS" : "Android",
          style: TextStyle(
            fontWeight: FontWeight.bold,
            fontSize: isTablet ? 18 : 16,
            color: isIOS ? Colors.blue : Colors.green,
          ),
        ),
        SizedBox(height: 8),
        
        // QR code - either generated or from assets
        if (generateQrCodes)
          QrImageView(
            data: platformLink,
            version: QrVersions.auto,
            size: isTablet ? 140.0 : 100.0,
            backgroundColor: Colors.white,
            errorStateBuilder: (context, error) => Center(
              child: Text('Error generating QR code'),
            ),
          )
        else
          Image.asset(
            isIOS ? 'assets/images/barcode_ios.png' : 'assets/images/barcode_android.png',
            height: isTablet ? 120.0 : 100.0,
            fit: BoxFit.contain,
          ),
          
        SizedBox(height: 8),
        
        // Share button
        Builder(
          builder: (innerContext) => ElevatedButton.icon(
            onPressed: () => _shareApp(innerContext, isIOS: isIOS),
            icon: Icon(Icons.share, size: isTablet ? 20 : 18),
            label: Text(isIOS ? "Share iOS" : "Share Android"),
            style: ElevatedButton.styleFrom(
              backgroundColor: isIOS ? Colors.blue : Colors.green,
              foregroundColor: Colors.white,
              padding: EdgeInsets.symmetric(
                horizontal: isTablet ? 16 : 12,
                vertical: isTablet ? 10 : 8,
              ),
              textStyle: TextStyle(fontSize: isTablet ? 16 : 14),
            ),
          ),
        ),
      ],
    );
  }
}
